下面给出一个在原始 MTSP-MD（多旅行商-多无人机协同路径规划）模型基础上，进行**“带时间窗（Time Windows）”**和**“双目标”**改造的示例新模型。该模型在保留原模型大部分要素的同时，引入了时间窗约束以及一个可线性化处理的双目标函数，以便在研究中可以兼顾“完成时间”与“总行驶代价”这两个不同侧重的优化目标。当然，你也可以根据自己的需求，对下面的模型做进一步简化或拓展。

---

# MTSP-MD-TW：带时间窗和双目标的多旅行商-多无人机协同路径问题

## 1. 集合与索引

- \( V = \{0,1,2,\dots,n,n+1\}\): 所有节点的集合。其中：
  - \(0\) 表示仓库（起点）
  - \(n+1\) 表示仓库（终点）
  - \(C = \{1,2,\dots,n\} \subset V\) 表示客户节点集
- \( K \): 无人机任务编号集合
- \( E = \{(i,j)\mid i,j \in V, i\neq j\}\): 可行弧段集合

---

## 2. 参数

与原模型相同的参数：
- \(w_U\): 无人机自重  
- \(w_i\): 客户 \(i\) 的包裹重量  
- \(Q\): 无人机最大载重量  
- \(\theta\): 无人机电池容量  
- \(\alpha\): 无人机单位时间能量消耗率  
- \(R\): 可用无人机总数量  
- \(t_{U,ij}\): 无人机从 \(i\) 到 \(j\) 的飞行时间  
- \(t_{G,ij}\): 卡车从 \(i\) 到 \(j\) 的行驶时间  
- \(s_{U,i}\): 无人机在客户 \(i\) 的服务时间  
- \(s_{G,i}\): 卡车在客户 \(i\) 的服务时间  
- \(M\): 一个足够大的正数（用于“大 M”方法）  

新引入的参数（时间窗与距离/代价）：
- \([E_i, L_i]\): 客户 \(i\) 的时间窗，表示**必须在时间窗内开始服务**（到达时间）  
  - \(E_i\): 客户 \(i\) 最早开始服务时间  
  - \(L_i\): 客户 \(i\) 最晚允许到达时间  
- \(d_{G,ij}\): 卡车在弧 \((i,j)\) 上行驶的距离或成本（若无实际距离，可直接设为卡车在弧上的“单位成本”）  
- \(d_{U,ij}\): 无人机在弧 \((i,j)\) 上飞行的距离或成本

---

## 3. 决策变量

与原模型相同的决策变量：

1. **路径决策变量**  
   \[
   \begin{aligned}
   &y_{ij} \in \{0,1\} &&\text{: 卡车是否使用弧 } (i,j)\\
   &x_{ijk} \in \{0,1\} &&\text{: 无人机任务 } k \text{ 是否使用弧 } (i,j)\\
   &z_{U,ik} \in \{0,1\} &&\text{: 客户 } i \text{ 是否由无人机任务 } k \text{ 服务}\\
   &z_{G,i} \in \{0,1\} &&\text{: 客户 } i \text{ 是否由卡车服务}\\
   &h_{L,ik} \in \{0,1\} &&\text{: 节点 } i \text{ 是否是无人机任务 } k \text{ 的起飞点}\\
   &h_{R,ik} \in \{0,1\} &&\text{: 节点 } i \text{ 是否是无人机任务 } k \text{ 的回收点}
   \end{aligned}
   \]

2. **时间决策变量**  
   \[
   \begin{aligned}
   &t_{G,A,i} \ge 0 &&\text{: 卡车到达节点 } i \text{ 的时间}\\
   &t_{G,L,i} \ge 0 &&\text{: 卡车离开节点 } i \text{ 的时间}\\
   &t_{U,A,i} \ge 0 &&\text{: 无人机到达节点 } i \text{ 的时间}\\
   &t_{U,L,i} \ge 0 &&\text{: 无人机离开节点 } i \text{ 的时间}
   \end{aligned}
   \]

3. **资源决策变量**  
   \[
   \begin{aligned}
   &r_i \in [0,R] &&\text{: 卡车离开节点 } i \text{ 时携带的无人机数量}\\
   &w_{U,i} \ge 0 &&\text{: 无人机离开节点 } i \text{ 时的载重量}\\
   &p_{U,i} \ge 0 &&\text{: 无人机离开节点 } i \text{ 时的剩余电量, } p_{U,i} \le \theta
   \end{aligned}
   \]

---

## 4. 新的目标函数

在原模型中，目标是 
\[
\min \max\{ t_{U,A,n+1}, \; t_{G,A,n+1} \},
\]
即最小化无人机和卡车全部回到仓库（终点）所需要的最晚完成时间（makespan）。

在此基础上，我们希望兼顾“总行驶代价（可理解为距离或燃料消耗）”与“完成时间”两个方面，构造**双目标**进行优化。通常可以通过以下两种方式进行改造：

1. **线性加权求和**  
   定义一个新的辅助变量 \(T\)，使其大于等于卡车和所有无人机到达终点的时间，从而线性化 “\(\max\{\dots\}\)”；再与总距离之和加权形成一个单目标。  
   \[
   \begin{aligned}
   & T \ge t_{G,A,n+1}, \quad T \ge t_{U,A,n+1} \quad \forall k \in K \;(\text{若有多架无人机任务，取它们的最大到达时间})\\
   & \min \quad w_1 \cdot T \;+\; w_2 \cdot \Bigl(\sum_{(i,j)\in E} d_{G,ij}\cdot y_{ij} + \sum_{k\in K}\sum_{(i,j)\in E} d_{U,ij}\cdot x_{ijk}\Bigr)
   \end{aligned}
   \]
   其中，\(w_1\) 和 \(w_2\) 分别是对“完成时间”和“总行驶距离（成本）”的权重。

2. **分层（层次）优化**  
   先将“完成时间”作为第一优先级目标进行优化，在其最优解空间或最优值范围内，再对“总行驶距离”进行第二优先级优化。这类方法一般需要两阶段或多次求解，实现上较复杂，但能更精准地体现主要目标优先级。

如果仅需一个新的**单目标**，可直接采用以上 (1) 中的“线性加权和”方法替换原目标；或者只保留其中一部分，如“最小化总距离”或“最小化完成时间”，灵活性较高。

---

## 5. 约束条件

### 5.1 路径与服务约束

原模型中的路径连续性、客户唯一服务、起降点等约束大体保持不变，包括：

1. **客户服务唯一性**  
   \[
   \sum_{k\in K} z_{U,ik} \;+\; z_{G,i} \;=\; 1, \quad \forall i \in C
   \]
2. **卡车路径连续性**  
   \[
   z_{G,i} \;=\; \sum_{j\in V} y_{j,i},\quad \forall i \in C
   \]
3. **无人机路径连续性**  
   \[
   h_{R,ik} \;+\;\sum_{j\in V} x_{i,j,k} \;=\; h_{L,ik} \;+\;\sum_{j\in V} x_{j,i,k}, \quad \forall i \in C,\; k \in K
   \]
4. **访问次数约束**  
   - \(\sum_{j\in V} x_{i,j,k} \le 1,\; \forall i \in V, k \in K\)  
   - \(\sum_{j\in V} y_{i,j} = \sum_{j\in V} y_{j,i} \le 1,\; \forall i \in V\)  
5. **起降点必须是卡车访问节点**  
   \[
   \sum_{k\in K} h_{L,ik} \;\le\; M \times \sum_{j\in V} y_{j,i}, \quad
   \sum_{k\in K} h_{R,ik} \;\le\; M \times \sum_{j\in V} y_{i,j}, \quad
   h_{L,ik} + h_{R,ik} \;\le\; 1
   \]

（此处不再逐一列出所有原模型的基础路径约束，可保持与原模型一致。）

---

### 5.2 资源约束

与原模型相同的载重、无人机数量、能量消耗等约束保持不变，包括：

1. **无人机载重约束**  
   \[
   \sum_{i\in C} w_i \cdot z_{U,i,k} \;\le\; Q, \quad \forall k \in K
   \]
2. **无人机数量与携带平衡**  
   \[
   r_{n+1} + \sum_{j\in C}\sum_{k\in K} x_{n+1,j,k} \;=\; R,  
   \]
   \[
   r_j + \sum_{l\in V}\sum_{k\in K} x_{j,l,k} \;\le\; r_i + \sum_{l\in V}\sum_{k\in K} x_{l,j,k} \;+\; M\cdot(1-y_{i,j}), \dots
   \]
   （具体形式可根据原文献中对 \(r_i\) 的定义进行保持或略作修改）
3. **电池能量更新约束**  
   \[
   p_{U,i} \;\ge\; \theta \;-\; M \times \sum_{k\in K} z_{U,i,k}, \quad \forall i\in V
   \]
   \[
   p_{U,j} \;\ge\; p_{U,i} \;-\; \alpha \times (t_{U,i,j} + s_{U,j}) \times (w_{U,j} + w_U + w_j), \quad \forall (i,j)\in E,\; k\in K 
   \]
   （若需要，可添加起飞/回收时电量充满、或考虑中途充电、换电池等复杂情形。）

---

### 5.3 时间约束

与原模型相同的“到离开时间”衔接与同步约束，基本保持不变：

1. **卡车时间**  
   \[
   t_{G,L,i} \;\ge\; t_{G,A,i} + s_{G,i}, \quad \forall i \in V
   \]
   \[
   t_{G,A,j} \;\ge\; t_{G,L,i} + t_{G,i,j} \;-\; M\cdot(1 - y_{i,j}), \quad \forall (i,j)\in E
   \]
2. **无人机时间**  
   \[
   t_{U,L,i} \;\ge\; t_{U,A,i} + s_{U,i}, \quad \forall i \in V
   \]
   \[
   t_{U,A,j} \;\ge\; t_{U,L,i} + t_{U,i,j} \;-\; M\cdot(1 - x_{i,j,k}), \quad \forall (i,j)\in E,\; k \in K
   \]
3. **无人机与卡车的起飞/回收同步**  
   \[
   t_{U,L,i} = t_{G,L,i},\quad \text{若 }h_{L,i,k}=1 
   \]
   \[
   t_{G,A,i} \ge t_{U,A,i},\quad \text{若 }h_{R,i,k}=1
   \]
   （或根据具体情形作相应的同步或等待时间约束。）

---

### 5.4 时间窗约束（新增）

对于每个被服务的客户 \(i \in C\)，如果该客户由卡车服务，则卡车到达时间必须落在其时间窗内；如果由无人机服务，则无人机到达时间必须落在其时间窗内。可采用以下**大 M**形式的线性约束：

\[
\begin{aligned}
&t_{G,A,i} \;\ge\; E_i \;-\; M\cdot (1 - z_{G,i}), \quad && \forall i\in C, \\
&t_{G,A,i} \;\le\; L_i \;+\; M\cdot (1 - z_{G,i}), \quad && \forall i\in C, \\
&t_{U,A,i} \;\ge\; E_i \;-\; M\cdot \bigl(1 - \sum_{k\in K}z_{U,i,k}\bigr), \quad && \forall i\in C, \\
&t_{U,A,i} \;\le\; L_i \;+\; M\cdot \bigl(1 - \sum_{k\in K}z_{U,i,k}\bigr), \quad && \forall i\in C.
\end{aligned}
\]

- 当 \(z_{G,i} = 1\)（卡车服务该客户）时，前两条约束便要求 \(t_{G,A,i}\) 必须在 \([E_i, L_i]\) 范围内；若 \(z_{G,i} = 0\)，则可由无人机服务，时间窗约束对卡车到达不再起作用（通过 \(M(1-z_{G,i})\) 使得不束缚）。  
- 对无人机同理：当某个 \(k\) 满足 \(z_{U,i,k} = 1\) 时，该无人机任务的到达时间 \(t_{U,A,i}\) 必须在 \([E_i, L_i]\) 范围内。

若研究需要“到达后可以等待至时间窗开始再服务”，可通过让服务开始时间 \(\ge \max(t_{G,A,i}, E_i)\) 等方式进一步细化时间窗模型；这里采用最基本的“到达时间窗内”形式示意。

---

## 6. 非负与域约束

与原模型保持一致：

\[
t_{G,A,i},\,t_{G,L,i},\,t_{U,A,i},\,t_{U,L,i},\,w_{U,i},\,p_{U,i} \ge 0, \quad \forall i\in V
\]
\[
0 \le r_i \le R,\quad \forall i\in V;\quad 0 \le p_{U,i} \le \theta,\quad \forall i\in V
\]
\[
x_{i,j,k},\,y_{i,j},\,z_{U,i,k},\,z_{G,i},\,h_{L,i,k},\,h_{R,i,k} \in \{0,1\}.
\]

---

# 综述

1. **核心改动**  
   - 引入**时间窗约束**：要求卡车 / 无人机在为客户 \(i\) 提供服务时，其到达时间需落在 \([E_i, L_i]\) 的窗口内（可通过大 \(M\) 技巧与二元服务变量结合，实现线性化）。
   - 将原本的“单目标：最小化完成时间”扩展为**双目标**：同时兼顾完成时间与总行驶代价(距离/成本)。可以使用线性加权和或分层优化的方式来处理。

2. **实际场景拓展**  
   - 时间窗约束通常用于具有严格送达时限或顾客可接收时段的场景。  
   - 双目标的设定在需要折中“配送总时长”和“里程/能耗”的场景尤其常见，比如在**无人机续航受限且能源昂贵**，以及**卡车也存在运输成本**时，都可能需要一起考虑。

3. **进一步研究方向**  
   - 若要突出时效性，可以将时间窗改为软时间窗：允许迟到但需支付惩罚成本。  
   - 若要优化更多因素（例如使用的无人机数量上限、碳排放、每条路径的使用次数限制等），可在此框架中继续添加相应的决策变量与约束。  
   - 如果需要**精确线性化**“\(\max\{\dots\}\)”形式，需引入额外的辅助变量以及对应不等式来保证辅助变量大于所有车辆最终完成时间。

该模型可作为你进一步研究 MTSP-MD 问题（或相关的无人机-卡车协同路径问题）时的参考起点，在保留原模型大部分结构的同时，增加了**时间窗**和**多目标**两个常见的扩展要素，以便更贴近具有实际约束和优化需求的场景。祝研究顺利!